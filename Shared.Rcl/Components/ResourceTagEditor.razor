@using RackPeek.Domain.UseCases.Tags
@typeparam TResource where TResource : RackPeek.Domain.Resources.Resource
@inject NavigationManager Nav
@inject IAddTagUseCase<TResource> AddTagUseCase
@inject IRemoveTagUseCase<TResource> RemoveTagUseCase

<div class="md:col-span-2 "
     data-testid="@BaseTestId">

    <div class="flex items-center justify-between mb-1 group"
         data-testid="@($"{BaseTestId}-header")">

        <div class="text-zinc-400">
            Tags
            <button class="hover:text-emerald-400 ml-1"
                    title="Add Tag"
                    data-testid="@($"{BaseTestId}-add")"
                    @onclick="OpenAddTag">
                +
            </button>
        </div>
    </div>

    @if (Resource.Tags.Any())
    {
        <div class="flex flex-wrap gap-2"
             data-testid="@($"{BaseTestId}-list")">

            @foreach (var tag in Resource.Tags.OrderBy(t => t))
            {
                <div class="flex text-xs rounded overflow-hidden border border-zinc-700"
                     data-testid="@($"{BaseTestId}-tag-{tag}")">

                    <button type="button"
                            class="px-2 py-0.5 bg-zinc-800 text-zinc-300 hover:bg-emerald-800 hover:text-emerald-200 transition"
                            title="View tag"
                            data-testid="@($"{BaseTestId}-tag-{tag}-view")"
                            @onclick="() => NavigateToTag(tag)">
                        @tag
                    </button>

                    <button type="button"
                            class="px-1 py-0.5 bg-zinc-800 text-zinc-400 hover:bg-red-800 hover:text-red-200 transition border-l border-zinc-700"
                            title="Remove tag"
                            data-testid="@($"{BaseTestId}-tag-{tag}-remove")"
                            @onclick="() => RemoveTag(tag)">
                        ✕
                    </button>

                </div>
            }
        </div>
    }

</div>

<CommaSeparatedStringModal
    IsOpen="_tagModalOpen"
    IsOpenChanged="v => _tagModalOpen = v"
    Title="Add Tags"
    Description="Enter one or more tags separated by commas"
    Label="Tags"
    TestIdPrefix="@BaseTestId"
    OnSubmit="HandleTagsSubmit" />

@code {
    [Parameter][EditorRequired] public TResource Resource { get; set; } = default!;
    [Parameter] public EventCallback OnTagsChanged { get; set; }
    [Parameter] public string? TestIdPrefix { get; set; }

    private bool _tagModalOpen;

    private string BaseTestId =>
        string.IsNullOrWhiteSpace(TestIdPrefix)
            ? "resource-tag-editor"
            : $"{TestIdPrefix}-resource-tag-editor";

    void OpenAddTag()
    {
        _tagModalOpen = true;
    }

    public async Task HandleTagsSubmit(IReadOnlyList<string> values)
    {
        foreach (var value in values)
        {
            await AddTagUseCase.ExecuteAsync(
                Resource.Name,
                value);
        }

        if (OnTagsChanged.HasDelegate)
            await OnTagsChanged.InvokeAsync();
    }

    async Task RemoveTag(string tag)
    {
        await RemoveTagUseCase.ExecuteAsync(
            Resource.Name,
            tag);

        if (OnTagsChanged.HasDelegate)
            await OnTagsChanged.InvokeAsync();
    }

    void NavigateToTag(string tag)
    {
        Nav.NavigateTo($"tags/{Uri.EscapeDataString(tag)}");
    }
}
