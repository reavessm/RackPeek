@page "/resources/systems/{SystemName}"
@using RackPeek.Domain.Persistence
@using RackPeek.Domain.Resources.Hardware
@using RackPeek.Domain.Resources.SystemResources
@using RackPeek.Domain.Resources.SystemResources.UseCases
@inject IResourceCollection Repo
@inject UpdateSystemUseCase UpdateSystemUseCase
@inject GetSystemServiceTreeUseCase GetSystemServiceTreeUseCase
@inject NavigationManager Nav

<PageTitle>System Details</PageTitle>

<ResourceBreadCrumbComponent
    ResourceType="ResourceType.System"
    ResourceName="@SystemName"/>

<div class="min-h-screen bg-zinc-950 text-zinc-200 font-mono p-6">
    @if (_system is null && !_loading)
    {
        <div class="text-zinc-500">System not found</div>
    }
    else if (_loading)
    {
        <div class="text-zinc-500">loading system…</div>
    }
    else
    {
        <h1 class="text-lg text-zinc-100 mb-6">
            @_system.Name (@_system.Kind)
        </h1>

        <SystemCardComponent System="_system" OnSave="UpdateSystem" OnDeleted="OnDeleted"/>

        @if (_tree is not null && _tree.Services.Any())
        {
            <SystemDependencyTreeComponent Tree="_tree"/>
        }
        else
        {
            <div class="text-zinc-400 m-2">
                No child systems / services
            </div>
        }

        <div class="m-4">
            <AddResourceComponent TResource="Service"
                                  Placeholder="Service name"
                                  OnCreated="NavigateToNewResource"
                                  RunsOn="@SystemName"/>
        </div>
    }
</div>

@code {
    [Parameter] public string SystemName { get; set; } = string.Empty;

    private SystemResource? _system;
    private bool _loading = true;
    SystemDependencyTree? _tree;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _system = await Repo.GetByNameAsync<SystemResource>(SystemName);
        _tree = null;
        if (!string.IsNullOrEmpty(_system?.Name))
        {
            _tree = await GetSystemServiceTreeUseCase.ExecuteAsync(_system?.Name!);
        }

        _loading = false;
    }

    async Task UpdateSystem(SystemEditModel edit)
    {
        await UpdateSystemUseCase.ExecuteAsync(
            edit.Name,
            edit.Type,
            edit.Os,
            edit.Cores,
            edit.Ram,
            edit.RunsOn,
            edit.Notes
        );
    }

    private async Task OnDeleted()
    {
        Nav.NavigateTo("/systems/list");
    }

    private Task NavigateToNewResource(string serverName)
    {
        Nav.NavigateTo($"resources/services/{serverName}");
        return Task.CompletedTask;
    }

}